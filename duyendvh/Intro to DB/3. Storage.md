https://15445.courses.cs.cmu.edu/fall2024/slides/03-storage1.pdf

![[Screenshot 2025-12-07 at 17.19.48.png]]


![[Screenshot 2025-12-07 at 17.39.12.png]]
![[Screenshot 2025-12-07 at 17.45.47.png]]
![[Screenshot 2025-12-07 at 17.46.13.png]]

![[Screenshot 2025-12-07 at 17.41.54.png]]



# ðŸš€ 1. **Storage & Table Size Monitoring**

## **ðŸ“Œ pg_database_size(name)**

**Concept:**  
Shows how much space a database consumes on disk.

**Why it matters:**  
Use it to detect which database is growing too fast or which one is too big.

**Example**

`SELECT pg_size_pretty(pg_database_size('mydb'));`

â†’ Returns human-readable size like `12 GB`.

---

## **ðŸ“Œ pg_relation_size(object)**

**Concept:**  
Returns **size of a single table OR index only** (WITHOUT children like TOAST or indexes).

**Useful when:**  
You want to know if a table or index is getting too big.

**Example**

`SELECT pg_size_pretty(pg_relation_size('orders'));`

---

## **ðŸ“Œ pg_total_relation_size(object)**

**Concept:**  
Returns **table + indexes + toast + toast indexes**.  
This is the **real total size** of a table.

**Example**

`SELECT pg_size_pretty(pg_total_relation_size('orders'));`

â†’ Use this to see how large a table REALLY is.

---

## **ðŸ“Œ pg_indexes_size(table)**

**Concept:**  
Shows total storage used **by all indexes** on a table.

**Why important:**  
Indexes can grow silently and consume more space than the table itself.

**Example**

`SELECT pg_size_pretty(pg_indexes_size('orders'));`

---

## **ðŸ“Œ pg_table_size(table)**

**Concept:**  
Shows size of table data (**excluding indexes**)  
but **including TOAST** (large text/binary).

**Example**

`SELECT pg_size_pretty(pg_table_size('orders'));`

---

## **ðŸ“Œ pg_tablespace_size(name)**

**Concept:**  
A tablespace is a directory on disk where data is stored.  
This function shows how much data is inside it.

**Example**

`SELECT pg_size_pretty(pg_tablespace_size('pg_default'));`

---

# ðŸš€ 2. **Cache & Buffer Monitoring**

## **ðŸ“Œ Cache Hit Ratio**

**Concept:**  
Measures how often PostgreSQL reads data **from memory (fast)**  
instead of **disk (slow)**.

High-performance DBs have **> 99% hit ratio**.

**Example**

`SELECT   sum(blks_hit) / nullif(sum(blks_hit + blks_read), 0) AS cache_hit_ratio FROM pg_stat_database;`

---

## **ðŸ“Œ pg_statio_user_tables**

**Concept:**  
Shows how many blocks were read from:

- **disk** (`heap_blks_read`)
    
- **cache** (`heap_blks_hit`)
    

**Use case:**  
Find tables that cause disk I/O.

**Example**

`SELECT relname, heap_blks_read, heap_blks_hit FROM pg_statio_user_tables;`

---

# ðŸš€ 3. **Index Monitoring**

## **ðŸ“Œ pg_stat_user_indexes**

**Concept:**  
Tracks how often an index was used (`idx_scan`).

**Why:**  
Unused indexes slow down writes and waste disk.

**Example â€” find unused indexes**

`SELECT     indexrelname, idx_scan FROM pg_stat_user_indexes WHERE idx_scan = 0;`

---

## **ðŸ“Œ High Sequential Scans = Missing index**

**Concept:**  
If a table is scanned sequentially (`seq_scan`) more than using indexes (`idx_scan`),  
it suggests indexes are missing or are not selective.

**Example**

`SELECT relname, seq_scan, idx_scan FROM pg_stat_user_tables WHERE seq_scan > idx_scan;`

---

# ðŸš€ 4. **Vacuum / Autovacuum Monitoring**

## **ðŸ“Œ n_dead_tup (dead tuples)**

**Concept:**  
Dead rows created by UPDATE/DELETE.  
PostgreSQL MUST vacuum them to free space.

**Example**

`SELECT relname, n_dead_tup FROM pg_stat_user_tables ORDER BY n_dead_tup DESC;`

---

## **ðŸ“Œ last_vacuum / last_autovacuum**

**Concept:**  
Shows when PostgreSQL last cleaned the table.

**Example**

`SELECT relname, last_vacuum, last_autovacuum FROM pg_stat_user_tables;`

---

## **ðŸ“Œ pgstattuple (needs extension)**

**Concept:**  
Estimates table **bloat** â€” wasted space due to dead tuples.

**Example**

`SELECT * FROM pgstattuple('orders');`

---

# ðŸš€ 5. **WAL / Checkpoint Monitoring**

## **ðŸ“Œ pg_stat_bgwriter**

**Concept:**  
Shows how often PostgreSQL performs checkpoints and buffer writes.  
Used to detect I/O pressure.

**Example**

`SELECT * FROM pg_stat_bgwriter;`

---

# ðŸš€ 6. **Lock Monitoring**

## **ðŸ“Œ pg_stat_activity (wait events)**

**Concept:**  
Shows what each backend is doing and if it is **waiting** on a lock.

**Example**

`SELECT     pid, usename, wait_event_type, wait_event, query FROM pg_stat_activity WHERE wait_event_type IS NOT NULL;`

---

## **ðŸ“Œ pg_locks**

**Concept:**  
Shows all locks currently held (row locks, table locks, etc.)

**Example**

`SELECT * FROM pg_locks;`

---

# ðŸš€ 7. **Connection Monitoring**

## **ðŸ“Œ Number of connections**

**Concept:**  
Tracks all active connections to the DB.

**Example**

`SELECT datname, count(*) FROM pg_stat_activity GROUP BY datname;`

---

# ðŸš€ 8. **Slow Query Monitoring**

## **ðŸ“Œ pg_stat_statements**

**Concept:**  
Tracks execution time, frequency, and total cost of each query.

**Why:**  
Most important performance extension.

**Example â€” slowest queries**

`SELECT query, mean_exec_time, calls FROM pg_stat_statements ORDER BY mean_exec_time DESC LIMIT 20;`

---

# ðŸš€ 9. **Table Statistics**

**Concept:**  
Shows table insert/update/delete activity and dead/live tuples.

**Example**

`SELECT     relname,     n_tup_ins, n_tup_upd, n_tup_del,     n_live_tup, n_dead_tup FROM pg_stat_user_tables;`

---

# ðŸš€ 10. **Freeze / XID Monitoring (pg_relation_*)**

## **ðŸ“Œ pg_relation_frozen_xid(oid)**

**Concept:**  
PostgreSQL uses transaction IDs (XIDs).  
If old rows aren't vacuum-frozen in time, **transaction wraparound** can crash the DB.

This function shows the oldest unfrozen transaction per table.

**Example**

`SELECT relname, pg_relation_frozen_xid(oid) FROM pg_class WHERE relkind='r';`

---

# ðŸš€ 11. **Free Space Monitoring**

## **ðŸ“Œ pg_freespace(rel)**

Requires: `pg_freespacemap`

**Concept:**  
Shows how much free space is available in each page of a table.

**Use case:**  
Detect tables with fragmentation.

**Example**

`SELECT * FROM pg_freespace('orders') LIMIT 10;`

---